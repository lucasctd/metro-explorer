<style>
	.ui-effects-transfer { border: 3px dashed gray; z-index: 99999}
	.picture{
		cursor: pointer;
		border-radius: 15px;
	}
	.inputWidth{
		width: 400px !important;
		font-size: 10pt;
		color: gray;
	}
</style>
<div class="_center">
	<div id="previewPictures" class="_center">
	</div>
	<br />
	<p id="shareHeader" class="txtcenter gray"></p>
	<div class="_center" style="width:80%;">
		<table>
			<tr>
				<td>
					<div id="shareLink" class="input-control text inputWidth" data-role="input">
						<input type="text" class="inputWidth" readonly="readonly">
						<button class="button"><span class="mif-search"></span></button>
					</div>
				</td>
			</tr>
			<tr>
				<td>
					<div id="shortLink" class="input-control text inputWidth" data-role="input">
						<input type="text" class="inputWidth" readonly="readonly">
						<button class="button"><span class="mif-rocket"></span></button>
					</div>
				</td>
			</tr>
			<tr>
				<td>
					<div id="previewLink" class="input-control text inputWidth" data-role="input">
						<input type="text" class="inputWidth" readonly="readonly">
						<button class="button"><span class=""></span></button>
					</div>
				</td>
			</tr>
			<tr>
				<td colspan="2">
					<span class="gray ft12" style="margin-left: 5px;">Public</span>
					<label class="switch" style="margin-left: 10px;">
						<input id="sharePublic" name="public" type="checkbox">
						<span class="check"></span>
					</label>
				</td>
			</tr>
		</table>
	</div>
	<center>
		<button id="buttonGenerateKey" class="explorerButton margin20" style="margin-top:25px;">Generate Key</button>
	</center>
</div>
<script type="application/javascript" charset="UTF-8">
	function share() {
		var file = explorer.TEMP_VAR;
		$("#shareHeader").html("Share <b>" + file.name + "</b>");
		var share = {id: $("#shareLink"), icon: $("#shareLink").find("button").find("span"), input: $("#shareLink").find("input"), button: $("#shareLink").find("button")};
		var shortLink = {id: $("#shortLink"), icon: $("#shortLink").find("button").find("span"), input: $("#shortLink").find("input"), button: $("#shortLink").find("button")};
		var previewLink = {id: $("#previewLink"), icon: $("#previewLink").find("button").find("span"), input: $("#previewLink").find("input"), button: $("#previewLink").find("button")};
		var url = ROOT_URL + "download/" + file.id + "?downloadKey=" + (file.downloadKey == null ? "" : file.downloadKey);
		preview(file);
		share.input.val(url);
		$("#sharePublic").prop('checked',file.public);
		if(file.downloadKey == null){
			share.icon.addClass("mif-share");
			share.button.prop("title", "Click here SHARE it.");
		}else{
			share.icon.addClass("mif-blocked");
			share.button.prop("title", "Click here to STOP sharing it.");
		}
		var def = $.Deferred();
		urlShorter(url, def);
		$.when(def).then(function(resp){
			shortLink.input.val(resp.id);
			shortLink.id.fadeIn("fast");
		});
		$("#buttonGenerateKey").on("click", function (){
			loading(true);
			$.post( "/generateDownloadKey/"+file.id, function( data ) {
				var url = ROOT_URL + "download/" + file.id + "?downloadKey=" + data.messages.message;
				file.downloadKey = data.messages.message;
				var def = $.Deferred();
				urlShorter(url, def);
				$.when(def).then(function(resp){
					if(data.success){
						share.input.val(url);
						shortLink.input.val(resp.id);
						share.icon.removeClass("mif-share");
						share.icon.addClass("mif-blocked");
						share.button.prop("title", "Click here to STOP sharing it.");
						loadPreview(file, previewLink);
					}else{
						notify.show("HUU", data.messages.message, {time : 9, type: notify.TYPE_ERROR});
					}
					loading(false);
				});
			}, 'json');
		});
		share.button.on("click", function (){
			if ($(share.icon).hasClass("mif-blocked")){
				loading(true);
				$.post( "/destroyDownloadKey/"+file.id, function( data ) {
					var def = $.Deferred();
					urlShorter(url, def);
					$.when(def).then(function(resp){
						if(data.success) {
							share.input.val(ROOT_URL + "download/=" + file.id + "?downloadKey=");
							shortLink.input.val(resp.id);
							share.icon.removeClass("mif-blocked");
							share.icon.addClass("mif-share");
							share.button.prop("title", "Click here to SHARE it.");
							file.downloadKey = "";
							loadPreview(file, previewLink);
						}else{
							notify.show("HUU", data.messages.message, {time : 9, type: notify.TYPE_ERROR});
						}
						loading(false);
					});
				}, 'json');
			}else{
				$("#buttonGenerateKey").click();
			}
		});
		loadPreview(file, previewLink);
		shortLink.button.on("click", function () {
			window.open(shortLink.input.val(),'_blank');
		});

		$("#sharePublic").on("change", function () {
			$.post( "/makePublic",{id: file.id, public: $(this).is(":checked")}, function( data ) {
				if(data.success) {
					if ($("#sharePublic").is(":checked")) {
						notify.show("HUU", "<b>" + file.name + "</b> is currently being shared to everyone on <a href='http://shareto.me.uk' target='_blank' style='color:white; text-decoration: underline;'>shareto.me.uk</a>", {time: 9});
					}
				}else{
					notify.show("HUU", data.messages.message, {time : 9, type: notify.TYPE_ERROR});
				}
			}, 'json');
		});
	}
	share();
	function supportedPreview(file){
		if(isSupportedPreviewImage(file)){
			return IMAGE;
		}else if(isSupportedPreviewVideo(file)){
			return VIDEO;
		}else if(isSupportedPreviewAudio(file)){
			return AUDIO;
		}else{
			return null;
		}
	}

	function loadPreview(file, previewLink){
		var previewType = supportedPreview(file);
		var previewUrl = null;
		var icon = null;
		switch (previewType){
			case IMAGE:
				icon = "mif-image";
				previewUrl = ROOT_URL+"/image/"+file.id+"?downloadKey="+file.downloadKey;
				break;
			case VIDEO:
				icon = "mif-film";
				previewUrl = ROOT_URL+"/multimedia/"+file.id+"?downloadKey="+file.downloadKey;
				break;
			case AUDIO:
				icon = "mif-music";
				previewUrl = ROOT_URL+"/multimedia/"+file.id+"?downloadKey="+file.downloadKey;
		}
		if(previewType != null){
			var def = $.Deferred();
			urlShorter(previewUrl, def);
			$.when(def).then(function(resp){
				previewLink.icon.addClass(icon);
				previewLink.input.val(resp.id);
				previewLink.button.prop("title", "Click to Open in a new tab.");
				previewLink.button.unbind( "click" );
				previewLink.button.on("click", function () {
					openURL(previewLink.input.val());
				});
			});
		}else{
			previewLink.id.fadeOut("fast");
		}
	}
</script>